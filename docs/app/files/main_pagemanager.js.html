<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>main\pagemanager.js - spaseed</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1>spaseed</h1>
            
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/event.html">event</a></li>
            
                <li><a href="../classes/manager.html">manager</a></li>
            
                <li><a href="../classes/net.html">net</a></li>
            
                <li><a href="../classes/pagemanager.html">pagemanager</a></li>
            
                <li><a href="../classes/router.html">router</a></li>
            
                <li><a href="../classes/util.html">util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: main\pagemanager.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

define(&#x27;main/pagemanager&#x27;, function(require, exports, module) {
	var $ = require(&#x27;$&#x27;);
	var router = require(&#x27;router&#x27;);
	var util = require(&#x27;util&#x27;);

	//首页模块名
	var root = &#x27;page1&#x27;;

	//layout配置
	var layoutConfig = {
		&#x27;default&#x27;: require(&#x27;main/layout/default&#x27;)
	};

	//css配置
	var cssConfig = {};

	//页面主容器
	var pageContainer = $(&#x27;#container&#x27;);

	//切换页面需要更改class的对象
	var pageClassWrap = pageContainer;

	//页面默认class, 切换页面需要保留的class
	var pageDefaultClass = &#x27;&#x27;;

	//默认标题
	var defaultTitle = window.defaultTitle = &#x27;spaseed&#x27;;

	//导航容器
	var navContainer = [$(&#x27;body&#x27;)];

	//导航选中态class
	var navActiveClass = &#x27;active&#x27;;

	/** 
	 * 页面管理
	 * @class pagemanager
	 * @static
	 */
	var pageManager = {
		/**
		 * 加载首页
		 * @method loadRoot
		 */
		loadRoot: function () {
			this._loadView(root);
		},

		/**
		 * 统一加载视图方法
		 * @method loadView
		 */
		loadView: function () {
			var _self = this,
				arr = [].slice.call(arguments);

			//解析路径
			this._parseUrl(arr, function (controller, action, params) {
				//处理路由, 加载视图
				_self._loadView(controller, action, params);
			})
		},

		/**
		 * 解析路径,处理url参数
		 * @method _parseUrlParams
		 * @param {Array}    arr 路由匹配到的参数
		 * @param {Function} cb  回调函数
		 */
		_parseUrl: function (arr, cb) {
			var controller = null,
				action = null,
				params = [],
				urlPara = null,
				clearParaStr = function (str) {
					return str.split(&#x27;?&#x27;)[0];
				};

			//获取url参数
			if (location.search) {
				var searchArr = location.search.substring(1).split(&#x27;&amp;&#x27;);
				urlPara = {};
				for (var i=0, item; item = searchArr[i]; i++) {
					var itemArr = item.split(&#x27;=&#x27;);
					urlPara[itemArr[0]] = itemArr[1];
				}
			}

			//获取controller
			if (/^\?/.test(arr[0])) {
				//匹配首页 /?from=xx 场景
				controller = root;
			} else { 
				//匹配其他页 如/xx?from=xx需清除url参数
				controller = clearParaStr(arr[0]);
			}

			//获取action与params
			if (arr.length &gt; 1) {
				if (/^\?/.test(arr[1])) {
					//匹配 /xx/?from=xx 场景
					action = &#x27;&#x27;;
				} else {
					action = clearParaStr(arr[1]);
					params = arr.slice(2);
					//如有路由参数, 数组最后一项需清除可能存在的url参数
					if (params.length) {
						var lstIdx = params.length-1,
							lstItemStr = params[lstIdx] = clearParaStr(params[lstIdx]);
						!lstItemStr &amp;&amp; params.splice(lstIdx, 1);
					}
				}
			}

			//将url参数放入params
			urlPara &amp;&amp; params.push(urlPara);

			cb(controller, action, params);
		},

		/**
		 * 统一路由处理函数
		 * @method _loadView
		 * @param {String} controller 
		 * @param {String} action 
		 * @param {Array} params 
		 */
		_loadView: function (controller, action, params) {
			var _self = this;

			if (_self.currentViewObj) {
				//全局销毁
				_self.globalDestroy();
				//销毁前一个
				var destroy = _self.currentViewObj.destroy;
                try {
				    destroy &amp;&amp; destroy.call(_self.currentViewObj);
				    if (_self.currentCtrlObj) {
				    	var ctrlDestroy = _self.currentCtrlObj.destroy;
				    	ctrlDestroy &amp;&amp; ctrlDestroy.call(_self.currentCtrlObj);
				    }
                } catch(e) {
                    window.console &amp;&amp; console.error &amp;&amp; console.error(&#x27;View destroy failed &#x27;, e);
                }
                _self.currentCtrlObj = null;
				_self.currentViewObj = null;
			}

			//渲染公共模版
			_self.renderLayout(controller, action, params);

			//模块基础路径
			var basePath = &#x27;modules/&#x27;;

			//模块id按照如下规则组成
			var controllerId = basePath + controller + &#x27;/&#x27; + controller,
				actionId = basePath + controller + &#x27;/&#x27; + action + &#x27;/&#x27; + action,
				view = action || controller;

			var moduleArr = [];

			//检查是否存在controller模块
			if (seajs.hasDefined[controllerId]) {
				moduleArr.push(controllerId);
			} else {
				controllerId = &#x27;&#x27;;
			}

			//检查是否存在action模块
			if (action) {
				if (!seajs.hasDefined[actionId]) {
					_self.render404();
					return
				}
				moduleArr.push(actionId);
			} else {
				// 未指明action，默认尝试查询index
				var indexUri = basePath + controller + &#x27;/index/index&#x27;;
				if (seajs.hasDefined[indexUri]) {
					moduleArr.push(indexUri);
					action = &#x27;index&#x27;;
				} else {
					//未指明action，且controller也不曾定义
					if (!controllerId) {
						_self.render404();
						return
					}
				}
			}

			//需加载的css资源
			var cssReqUrl = _self.addCssReq(controller, action);

			//加载css
			cssReqUrl.length &amp;&amp; require.async(cssReqUrl);	

			//获取页面模块对外接口
			require.async(moduleArr, function(cObj, aObj) {
				
				//controller未定义, 此时cObj属于一个action 
				if (!controllerId) {
					aObj = cObj;
				}

				//执行controller, 判断同contoller下的action切换, contoller不需要再重复执行
				if (controllerId &amp;&amp; (!_self.fragment || _self.fragment.indexOf(&#x27;/&#x27; + controller) &lt; 0 || !action)) {
					_self.renderView(cObj, params);
				} 
				_self.fragment = router.fragment;

				//执行action
				if (action) {
					_self.renderView(aObj, params);
					_self.currentViewObj = aObj;
					controllerId &amp;&amp; (_self.currentCtrlObj = cObj);
				} else {
					_self.currentViewObj = cObj;
				}

				//更改导航状态
		  		_self.changeNavStatus(view); 

		  		//设置页面标题
		  		_self.setTitle(cObj, aObj);
				
			});

		},


		/**
		 * 通过配置组装css请求
		 * (单页面模式会有先出dom后出样式的情况，不建议使用这种动态加载方式)
		 * @method addCssReq
		 * @param  {String} controller 
		 * @param  {String} action 
		 * @return {Array}  
		 */
		addCssReq: function (controller, action) {
			var controllerCssReq = cssConfig[controller],
				actionCssReq = cssConfig[controller + &#x27;_&#x27; + action],
				reqUrl = [],
				concatReqUrl = function (cssArr) {
                    for (var i = 0; i &lt; cssArr.length; i++) {
                       //csspath可通过seajs的map参数配置映射
					   cssArr[i] &amp;&amp; (reqUrl = reqUrl.concat(&#x27;csspath/&#x27; + cssArr[i]));
                    }
				}; 

			controllerCssReq &amp;&amp; concatReqUrl(controllerCssReq[&#x27;cssFile&#x27;]);	
			actionCssReq &amp;&amp; concatReqUrl(actionCssReq[&#x27;cssFile&#x27;]);
			return reqUrl;
		},

		/**
		 * 渲染公共模版
		 * @method renderLayout
		 * @param {String} controller 
		 * @param {String} action 
		 * @param {Array} params 
		 */
		renderLayout: function (controller, action, params) {
			var _self = this,
				_render = function (layoutName) {
				if (_self.layout != layoutName) {
					layoutConfig[layoutName].render();
					_self.layout = layoutName;
				} 
			};
			//可通过controller参数使用其他layout
			/*switch (controller) {
				case &#x27;xx&#x27;:
					_render(&#x27;xx&#x27;);
					break;
				default:
					_render(&#x27;default&#x27;);
			}*/
			_render(&#x27;default&#x27;);
		},

		/**
		 * 渲染视图
		 * @method renderView
		 * @param {String} obj 模块对象
		 * @param {String} params 参数
		 */
		renderView: function (obj, params) {
			if (obj) {
				var defaultClass = pageDefaultClass;
				//页面模块通过属性pageClass来变更样式
				if (obj.pageClass) { 
					pageClassWrap.attr(&#x27;class&#x27;, defaultClass + &#x27; &#x27; + obj.pageClass);
				} else {
					if (pageClassWrap.attr(&#x27;class&#x27;) != defaultClass) {
						pageClassWrap.attr(&#x27;class&#x27;, defaultClass);
					}
				}
			}
            
			if (obj &amp;&amp; obj.render) {
				obj.render.apply(obj, params);
			} else {
				this.render404();
			}
		},

		/**
		 * 渲染404
		 * @method render404
		 */
		render404: function () {
			var notFound = &#x27;&lt;h2 id=&quot;tt404&quot; style=&quot;text-align:center;padding-top:100px;font-size:20px;line-height:1.5;color:#999&quot;&gt; &lt;p&gt;404&lt;/p&gt; 您访问的页面没有找到! &lt;/h2&gt;&#x27;;
			var container = pageContainer;
			container &amp;&amp; container.html(notFound);
		},

		/**
		 * 设置页面标题
		 * @method setTitle
		 * @param {Object} cObj controller模块对象
		 * @param {Object} aObj action模块对象
		 */
		setTitle: function (cObj, aObj) {
			if (aObj &amp;&amp; aObj.title) {
				document.title = aObj.title;
			} else if (cObj &amp;&amp; cObj.title) {
				document.title = cObj.title;
			} else {
				if (document.title != defaultTitle) {
					document.title = defaultTitle;
				}
			}
		},

		/**
		 * 改变导航选中态
		 * @method changeNavStatus
		 * @param {String} view 当前视图
		 */
		changeNavStatus: function (view) {
			var _self = this,
				fragment = this.fragment;

			var changeNav = function (navcon, links) {
				navcon.find(&#x27;.&#x27; + navActiveClass).removeClass(navActiveClass);
				for (var i = 0, item; item = links[i]; i++) {
			        var href = util.getHref(item);
			        
			        if ( (href === &#x27;/&#x27; &amp;&amp; view === root) || (href !== &#x27;/&#x27; &amp;&amp; fragment.indexOf(href) == 0) ) {
			          var itemParent = $(item).parent();
			          if (navcon.find(&#x27;.&#x27; + navActiveClass).length) {
			          	(fragment === href) &amp;&amp; itemParent.addClass(navActiveClass);
			          } else {
			          	itemParent.addClass(navActiveClass);
			          }
				      
			        }
			    }
			};

			for (var i=0, navcon; navcon = navContainer[i]; i++) {
				changeNav(navcon, navcon.find(&#x27;a&#x27;));
			}
		},

		/**
		 * 页面切换时全局销毁
		 * @method globalDestroy
		 */
		globalDestroy: function () {
			
		},

		/**
		 * 重置fragment标记
		 * @method resetFragment
		 */
		resetFragment: function () {
			this.fragment = &#x27;&#x27;;
		}

	};
	
	module.exports = pageManager;
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
